name: DigitalOcean
on:
  workflow_dispatch:
  workflow_run:
    workflows:
      - Docker
    types:
      - completed

jobs:
  garbage-collection:
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    steps:
      - name: Check if relevant jobs ran
        id: check-jobs
        if: github.event_name == 'workflow_run'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const run_id = context.payload.workflow_run.id;
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: run_id,
            });
            const jobNames = jobs.data.jobs.map(job => job.name);
            const hasRelevantJob = jobNames.some(name => 
              name === 'buildx-next' || name === 'buildx-next-pull-request'
            );
            console.log('Jobs in workflow run:', jobNames);
            console.log('Has relevant job:', hasRelevantJob);
            return hasRelevantJob;
          result-encoding: string
      - name: Trigger garbage collection
        if: |
          github.event_name == 'workflow_dispatch' ||
          (github.event_name == 'workflow_run' && steps.check-jobs.outputs.result == 'true')
        run: |
          curl -f -v -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}" \
            "https://api.digitalocean.com/v2/registry/gogs/garbage-collection"
      - name: Send email on failure
        uses: dawidd6/action-send-mail@2cea9617b09d79a095af21254fbcb7ae95903dde # v3.12.0
        if: ${{ failure() }}
        with:
          server_address: smtp.mailgun.org
          server_port: 465
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: GitHub Actions (${{ github.repository }}) job result
          to: github-actions-8ce6454@unknwon.io
          from: GitHub Actions (${{ github.repository }})
          reply_to: noreply@unknwon.io
          body: |
            The job "${{ github.job }}" of ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }} completed with "${{ job.status }}".

            View the job run at: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
